# Handoff: Cursor Proxy Injection & Framing Fix

**Date:** 2026-01-02
**Previous Agent:** Maxim
**Status:** âœ… SUCCESS (Context File Injection Strategy)

## ðŸš¨ Critical Context

We are building a transparent MITM proxy to inject context into Cursor AI chat requests.

**The Breakthrough:**
We successfully reverse-engineered the Protobuf structure for `ConversationEntry` (Field 3). Instead of trying to forge a complex "User Message" (which requires UUIDs, specific types, and breaks checksums), we discovered that we can inject **Context Files**.

The backend treats polymorphic entries in `ConversationHistory` based on their wire format. By using the "Context File" schema (Field 1=Filename, Field 2=Content, Field 5=0), we can inject system prompts that appear as `system-context.md` files in the conversation context.

## ðŸ› ï¸ Current State

1. **Proxy is Running**: Started via `nohup` on port 8443.
   - Logs: `/tmp/cursor-proxy.log`
   - **Corrected Logic**: `src/injection.rs` now recursively finds the conversation history and inserts a simulated context file.
   - **Checksums**: We are **forwarding** `x-cursor-checksum` (critical) but stripping `content-length` (to avoid size mismatch errors).

2. **Verification**:
   - User reported: "message sent and agent is going"
   - Capture analysis (`/tmp/cursor-req-*-after.bin`) shows `system-context.md` successfully inserted as Entry #1.

3. **Known Noise**:
   - `AnalyticsService` and `NetworkService` throw `FRAME_SIZE_ERROR`. **Ignore these.** They do not affect Chat.

## â­ï¸ Immediate Next Steps for New Agent

1. **Clean Up**:
   - Remove temporary files: `rm /tmp/inspect_*.py`
   - Commit the working code: `src/injection.rs` and `src/main.rs`.
   
2. **Refinement**:
   - Implement configuration for the injected filename (currently hardcoded as `system-context.md`).
   - Add unit tests for the injection logic.

## ðŸš€ Commands

```bash
# Check logs
tail -n 50 -f /tmp/cursor-proxy.log

# Restart Proxy (if needed)
pkill -f 'cursor-proxy start'
cd tools/proxy-test/cursor-proxy
nohup cargo run --release -- --port 8443 --verbose --inject --inject-prompt "System prompt injected." > /tmp/cursor-proxy.log 2>&1 &
```
