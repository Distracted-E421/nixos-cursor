name: Cursor Studio CI/CD

on:
  push:
    branches: [main, dev, feature/*]
    paths:
      - 'cursor-studio-egui/**'
      - '.github/workflows/cursor-studio.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'cursor-studio-egui/**'
  workflow_dispatch:
    inputs:
      build_release:
        description: 'Build release binaries'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================
  # Quick checks - run on every push
  # ============================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cursor-studio-egui
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cursor-studio-egui
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev libwayland-dev
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: true  # Don't fail on warnings for now

  test:
    name: Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cursor-studio-egui
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cursor-studio-egui
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev libwayland-dev
      
      - name: Run tests
        run: cargo test --all-features --verbose

  # ============================================
  # Build matrix - Linux and macOS
  # ============================================
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    needs: [lint, test]
    defaults:
      run:
        working-directory: cursor-studio-egui
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cursor-studio-egui
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
            libxcb-xfixes0-dev libxkbcommon-dev libssl-dev libwayland-dev
      
      - name: Build release
        run: cargo build --release --verbose
      
      - name: Check binary
        run: |
          ls -la target/release/cursor-studio
          file target/release/cursor-studio
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cursor-studio-linux-x86_64
          path: cursor-studio-egui/target/release/cursor-studio
          retention-days: 7

  build-macos-intel:
    name: Build macOS x86_64 (Intel)
    runs-on: macos-13  # Intel Mac
    needs: [lint, test]
    defaults:
      run:
        working-directory: cursor-studio-egui
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cursor-studio-egui
      
      - name: Build release
        run: cargo build --release --verbose
      
      - name: Check binary
        run: |
          ls -la target/release/cursor-studio
          file target/release/cursor-studio
          otool -L target/release/cursor-studio || true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cursor-studio-macos-x86_64
          path: cursor-studio-egui/target/release/cursor-studio
          retention-days: 7

  build-macos-arm:
    name: Build macOS ARM64 (Apple Silicon)
    runs-on: macos-14  # Apple Silicon Mac
    needs: [lint, test]
    defaults:
      run:
        working-directory: cursor-studio-egui
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cursor-studio-egui
      
      - name: Build release
        run: cargo build --release --verbose
      
      - name: Check binary
        run: |
          ls -la target/release/cursor-studio
          file target/release/cursor-studio
          otool -L target/release/cursor-studio || true
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cursor-studio-macos-arm64
          path: cursor-studio-egui/target/release/cursor-studio
          retention-days: 7

  # ============================================
  # Nix builds - comprehensive validation
  # ============================================
  nix-build-linux:
    name: Nix Build (Linux)
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Build with Nix
        run: |
          cd cursor-studio-egui
          nix build --print-build-logs
      
      - name: Check result
        run: |
          cd cursor-studio-egui
          ls -la result/bin/
          result/bin/cursor-studio --version || echo "No --version flag"

  # ============================================
  # Release job - only on tags or manual trigger
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-intel, build-macos-arm, nix-build-linux]
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.build_release == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Linux
          cp artifacts/cursor-studio-linux-x86_64/cursor-studio release/cursor-studio-linux-x86_64
          chmod +x release/cursor-studio-linux-x86_64
          
          # macOS Intel
          cp artifacts/cursor-studio-macos-x86_64/cursor-studio release/cursor-studio-macos-x86_64
          chmod +x release/cursor-studio-macos-x86_64
          
          # macOS ARM
          cp artifacts/cursor-studio-macos-arm64/cursor-studio release/cursor-studio-macos-arm64
          chmod +x release/cursor-studio-macos-arm64
          
          # Create checksums
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/cursor-studio-linux-x86_64
            release/cursor-studio-macos-x86_64
            release/cursor-studio-macos-arm64
            release/checksums.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # Summary job
  # ============================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build-linux, build-macos-intel, build-macos-arm, nix-build-linux]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Cursor Studio CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux Build | ${{ needs.build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Intel Build | ${{ needs.build-macos-intel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS ARM Build | ${{ needs.build-macos-arm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nix Build | ${{ needs.nix-build-linux.result }} |" >> $GITHUB_STEP_SUMMARY
