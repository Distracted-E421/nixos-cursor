name: Validate Pre-Release

on:
  push:
    branches:
      - pre-release
  pull_request:
    branches:
      - pre-release

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v13
        with:
          name: nixos-cursor
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
          skipPush: true  # Only read from cache

      - name: Validate no private content leaked
        run: |
          echo "üîç Checking for private .cursor/ artifacts..."
          
          # Check for chat history
          if [[ -d .cursor/chat-history ]]; then
            echo "‚ùå ERROR: Found .cursor/chat-history/ in pre-release branch"
            exit 1
          fi
          
          # Check for agent configs
          if [[ -f .cursor/maxim.json ]] || [[ -f .cursor/gorky.json ]]; then
            echo "‚ùå ERROR: Found agent configs in pre-release branch"
            exit 1
          fi
          
          echo "‚úÖ No private content detected"

      - name: Run nix flake check
        run: |
          nix flake check --all-systems

      - name: Build Cursor package (x86_64-linux)
        run: |
          nix build .#cursor --print-build-logs
