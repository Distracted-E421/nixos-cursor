#!/usr/bin/env bash
#
# cursor-studio - Enhanced Cursor IDE launcher with proxy support
#
# Usage:
#   cursor-studio                    # Normal launch
#   cursor-studio --proxy            # Launch with proxy enabled
#   cursor-studio proxy <command>    # Proxy management commands
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROXY_BIN="${SCRIPT_DIR}/cursor-proxy/target/release/cursor-proxy"

# Try to find Nix-built dialog daemon first (properly wrapped with libraries)
# Fall back to cargo-built version if Nix isn't available
NIX_DIALOG_PKG=""
if command -v nix >/dev/null 2>&1; then
    NIX_DIALOG_PKG=$(nix build "${SCRIPT_DIR}/.."#cursor-dialog-daemon --no-link --print-out-paths 2>/dev/null || true)
fi

if [[ -n "$NIX_DIALOG_PKG" && -x "${NIX_DIALOG_PKG}/bin/cursor-dialog-daemon" ]]; then
    DIALOG_DAEMON_BIN="${NIX_DIALOG_PKG}/bin/cursor-dialog-daemon"
    DIALOG_CLI_BIN="${NIX_DIALOG_PKG}/bin/cursor-dialog-cli"
else
    DIALOG_DAEMON_BIN="${SCRIPT_DIR}/cursor-dialog-daemon/target/release/cursor-dialog-daemon"
    DIALOG_CLI_BIN="${SCRIPT_DIR}/cursor-dialog-daemon/target/release/cursor-dialog-cli"
fi

PROXY_DIR="${HOME}/.cursor-proxy"
CONFIG_DIR="${HOME}/.config/cursor-studio"
DIALOG_CONFIG="${CONFIG_DIR}/dialog-daemon.conf"
CURSOR_RULES_DIR="${HOME}/.cursor/rules"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[cursor-studio]${NC} $1"; }
log_success() { echo -e "${GREEN}[cursor-studio]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[cursor-studio]${NC} $1"; }
log_error() { echo -e "${RED}[cursor-studio]${NC} $1"; }

# Check if proxy binary exists
check_proxy() {
    if [[ ! -f "$PROXY_BIN" ]]; then
        log_error "Proxy binary not found at $PROXY_BIN"
        log_info "Building proxy..."
        (cd "${SCRIPT_DIR}/cursor-proxy" && cargo build --release)
    fi
}

# Initialize proxy (generate CA if needed)
init_proxy() {
    check_proxy
    "$PROXY_BIN" init "$@"
}

# Start proxy daemon
start_proxy() {
    check_proxy
    
    local mode_flag=""
    local port=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --dns-mode|-d) mode_flag="--dns-mode"; shift ;;
            --transparent|-t) mode_flag="--transparent"; shift ;;
            --port|-p) port="--port $2"; shift 2 ;;
            *) shift ;;
        esac
    done
    
    if [[ -z "$mode_flag" ]]; then
        log_info "No mode specified. Use --dns-mode (recommended) or --transparent (legacy)"
        log_info "  --dns-mode: Requires /etc/hosts entry, no DNS rotation issues"
        log_info "  --transparent: Uses iptables, may have DNS rotation issues"
        exit 1
    fi
    
    log_info "Starting proxy with ${mode_flag}..."
    "$PROXY_BIN" start $mode_flag $port --foreground
}

# Stop proxy
stop_proxy() {
    check_proxy
    "$PROXY_BIN" stop
}

# Show proxy status
proxy_status() {
    check_proxy
    "$PROXY_BIN" status
}

# Trust CA
trust_ca() {
    check_proxy
    "$PROXY_BIN" trust-ca "$@"
}

# Cleanup
cleanup_proxy() {
    check_proxy
    "$PROXY_BIN" cleanup "$@"
}

# Manage iptables
manage_iptables() {
    check_proxy
    "$PROXY_BIN" iptables "$@"
}

# Enable proxy
enable_proxy() {
    check_proxy
    "$PROXY_BIN" enable
}

# Disable proxy
disable_proxy() {
    check_proxy
    "$PROXY_BIN" disable
}

# ==================== Dialog Daemon Management ====================

# Check if dialog daemon binary exists
check_dialog_daemon() {
    if [[ ! -f "$DIALOG_DAEMON_BIN" ]]; then
        log_error "Dialog daemon binary not found at $DIALOG_DAEMON_BIN"
        log_info "Building dialog daemon..."
        (cd "${SCRIPT_DIR}/cursor-dialog-daemon" && cargo build --release)
    fi
}

# Check if systemd user service is available
has_systemd_service() {
    systemctl --user cat cursor-dialog-daemon >/dev/null 2>&1
}

# Check if service is managed by Home Manager (in /nix/store)
is_home_manager_service() {
    local service_path
    service_path=$(systemctl --user show cursor-dialog-daemon -p FragmentPath 2>/dev/null | cut -d= -f2)
    [[ "$service_path" == /nix/store/* ]]
}

# Check if dialog daemon is running (systemd or process)
is_dialog_daemon_running() {
    if has_systemd_service; then
        systemctl --user is-active cursor-dialog-daemon >/dev/null 2>&1
    else
        pgrep -f "cursor-dialog-daemon" > /dev/null 2>&1
    fi
}

# Create a transient systemd user service for non-NixOS users
create_user_service() {
    local service_dir="${HOME}/.config/systemd/user"
    local service_file="${service_dir}/cursor-dialog-daemon.service"
    
    mkdir -p "$service_dir"
    
    # Note: The binary path is resolved at service creation time.
    # If using Nix-built binary, it has proper library wrapping.
    # If using cargo-built binary, users may need to ensure wayland libs are available.
    cat > "$service_file" << EOF
[Unit]
Description=Cursor Dialog Daemon for AI Agent Feedback
Documentation=https://github.com/e421/nixos-cursor
After=graphical-session.target
PartOf=graphical-session.target

[Service]
Type=simple
ExecStart=${DIALOG_DAEMON_BIN}
Restart=on-failure
RestartSec=5s
# These are typically set by graphical-session.target but we set them explicitly
Environment=DISPLAY=:0
Environment=WAYLAND_DISPLAY=wayland-0
# XDG runtime dir for Wayland socket
Environment=XDG_RUNTIME_DIR=%t

[Install]
WantedBy=graphical-session.target
EOF
    
    systemctl --user daemon-reload
    log_success "Created systemd user service (using: ${DIALOG_DAEMON_BIN})"
}

# Start dialog daemon (prefer systemd if available)
start_dialog_daemon() {
    check_dialog_daemon
    
    if is_dialog_daemon_running; then
        log_info "Dialog daemon already running"
        return 0
    fi
    
    # Try systemd first
    if has_systemd_service; then
        log_info "Starting dialog daemon via systemd..."
        systemctl --user start cursor-dialog-daemon
    elif command -v systemctl >/dev/null 2>&1; then
        # Create and use systemd service for better lifecycle management
        log_info "Creating systemd user service..."
        create_user_service
        log_info "Starting dialog daemon via systemd..."
        systemctl --user start cursor-dialog-daemon
    else
        # Fallback to nohup for non-systemd systems
        log_info "Starting dialog daemon (no systemd)..."
        nohup "$DIALOG_DAEMON_BIN" > "${CONFIG_DIR}/dialog-daemon.log" 2>&1 &
    fi
    
    sleep 1
    
    if is_dialog_daemon_running; then
        log_success "Dialog daemon started"
        
        # Verify with ping
        if "$DIALOG_CLI_BIN" ping 2>/dev/null | grep -q "pong"; then
            log_success "Dialog daemon responding"
        fi
    else
        log_error "Failed to start dialog daemon"
        log_info "Check logs: journalctl --user -u cursor-dialog-daemon"
        return 1
    fi
}

# Stop dialog daemon
stop_dialog_daemon() {
    if has_systemd_service && systemctl --user is-active cursor-dialog-daemon >/dev/null 2>&1; then
        log_info "Stopping dialog daemon via systemd..."
        systemctl --user stop cursor-dialog-daemon
        log_success "Dialog daemon stopped"
    elif is_dialog_daemon_running; then
        log_info "Stopping dialog daemon..."
        pkill -f "cursor-dialog-daemon" || true
        sleep 1
        log_success "Dialog daemon stopped"
    else
        log_info "Dialog daemon not running"
    fi
}

# Enable dialog feature (install rules + start daemon + enable systemd autostart)
enable_dialog_feature() {
    check_dialog_daemon
    mkdir -p "$CURSOR_RULES_DIR"
    
    # Copy the interactive dialog rules
    local rules_source="${SCRIPT_DIR}/cursor-dialog-daemon/.cursor/rules/interactive-dialogs.mdc"
    local rules_dest="${CURSOR_RULES_DIR}/interactive-dialogs.mdc"
    
    if [[ -f "$rules_source" ]]; then
        cp "$rules_source" "$rules_dest"
        log_success "Installed dialog rules to $rules_dest"
    else
        log_warn "Dialog rules not found at $rules_source"
        log_info "Creating basic rules..."
        cat > "$rules_dest" << 'RULES_EOF'
# Interactive Dialog System

When the user asks for input or you need clarification, use the `cursor-dialog-cli` tool:

## Choice Dialog
```bash
cursor-dialog-cli -t 60 choice \
  --title "Title" \
  --prompt "Question?" \
  --options '[{"value":"a","label":"Option A"},{"value":"b","label":"Option B"}]'
```

## Text Input
```bash
cursor-dialog-cli -t 60 text \
  --title "Input" \
  --prompt "Enter value:" \
  --placeholder "hint"
```

## Confirmation
```bash
cursor-dialog-cli -t 60 confirm \
  --title "Confirm" \
  --prompt "Are you sure?"
```

The response is JSON with `selection`, `comment`, and `cancelled` fields.
RULES_EOF
        log_success "Created basic dialog rules"
    fi
    
    # Save enabled state
    echo "DIALOG_ENABLED=true" > "$DIALOG_CONFIG"
    
    # Create and enable systemd service (if systemd is available)
    if command -v systemctl >/dev/null 2>&1; then
        if is_home_manager_service; then
            # Service is managed by Home Manager, don't overwrite
            log_info "Service managed by Home Manager - skipping service creation"
        else
            # Always recreate the service file to ensure it points to the correct binary
            # (might have been updated between cargo-built and nix-built)
            create_user_service
        fi
        systemctl --user enable cursor-dialog-daemon 2>/dev/null || true
        log_success "Enabled systemd autostart"
    fi
    
    # Start daemon
    start_dialog_daemon
    
    log_success "Dialog feature enabled"
    echo ""
    log_info "The daemon will now start automatically on login."
    log_info "Restart Cursor for rules to take effect."
}

# Disable dialog feature (remove rules + stop daemon + disable systemd autostart)
disable_dialog_feature() {
    # Stop daemon
    stop_dialog_daemon
    
    # Disable systemd autostart (if using systemd)
    if command -v systemctl >/dev/null 2>&1 && has_systemd_service; then
        systemctl --user disable cursor-dialog-daemon 2>/dev/null || true
        log_info "Disabled systemd autostart"
    fi
    
    # Remove rules
    local rules_dest="${CURSOR_RULES_DIR}/interactive-dialogs.mdc"
    if [[ -f "$rules_dest" ]]; then
        rm -f "$rules_dest"
        log_info "Removed dialog rules"
    fi
    
    # Save disabled state
    echo "DIALOG_ENABLED=false" > "$DIALOG_CONFIG"
    
    log_success "Dialog feature disabled"
}

# Show dialog daemon status
dialog_status() {
    check_dialog_daemon
    
    echo ""
    log_info "=== Dialog Daemon Status ==="
    echo ""
    
    # Check if enabled
    if [[ -f "$DIALOG_CONFIG" ]] && grep -q "DIALOG_ENABLED=true" "$DIALOG_CONFIG" 2>/dev/null; then
        echo -e "  Feature:  ${GREEN}enabled${NC}"
    else
        echo -e "  Feature:  ${YELLOW}disabled${NC}"
    fi
    
    # Check systemd service
    if command -v systemctl >/dev/null 2>&1; then
        if has_systemd_service; then
            local mgmt_type="systemd"
            if is_home_manager_service; then
                mgmt_type="Home Manager"
            fi
            if systemctl --user is-enabled cursor-dialog-daemon >/dev/null 2>&1; then
                echo -e "  Autostart: ${GREEN}enabled${NC} (${mgmt_type})"
            else
                echo -e "  Autostart: ${YELLOW}disabled${NC} (${mgmt_type})"
            fi
        else
            echo -e "  Autostart: ${YELLOW}not configured${NC}"
        fi
    else
        echo -e "  Autostart: ${YELLOW}no systemd${NC}"
    fi
    
    # Check if running
    if is_dialog_daemon_running; then
        echo -e "  Daemon:   ${GREEN}running${NC}"
        
        # Show how it's running
        if has_systemd_service && systemctl --user is-active cursor-dialog-daemon >/dev/null 2>&1; then
            echo -e "  Manager:  ${BLUE}systemd${NC}"
        else
            echo -e "  Manager:  ${YELLOW}manual/nohup${NC}"
        fi
        
        # Try ping
        if "$DIALOG_CLI_BIN" ping 2>/dev/null | grep -q "pong"; then
            echo -e "  D-Bus:    ${GREEN}connected${NC}"
        else
            echo -e "  D-Bus:    ${YELLOW}not responding${NC}"
        fi
    else
        echo -e "  Daemon:   ${RED}stopped${NC}"
        echo -e "  D-Bus:    ${RED}unavailable${NC}"
    fi
    
    # Check rules
    local rules_dest="${CURSOR_RULES_DIR}/interactive-dialogs.mdc"
    if [[ -f "$rules_dest" ]]; then
        echo -e "  Rules:    ${GREEN}installed${NC} ($rules_dest)"
    else
        echo -e "  Rules:    ${YELLOW}not installed${NC}"
    fi
    
    # Check if CLI is in PATH
    if command -v cursor-dialog-cli >/dev/null 2>&1; then
        echo -e "  CLI:      ${GREEN}in PATH${NC} ($(which cursor-dialog-cli))"
    else
        echo -e "  CLI:      ${YELLOW}not in PATH${NC}"
        echo -e "            Use: $DIALOG_CLI_BIN"
    fi
    
    echo ""
    
    # Help text
    if ! is_dialog_daemon_running; then
        log_info "To start: cursor-studio dialog start"
        log_info "To enable (with autostart): cursor-studio dialog enable"
    fi
}

# Test dialog (show a quick test dialog)
dialog_test() {
    check_dialog_daemon
    
    if ! is_dialog_daemon_running; then
        log_error "Dialog daemon not running. Start with: cursor-studio dialog start"
        return 1
    fi
    
    log_info "Showing test dialog..."
    "$DIALOG_CLI_BIN" -t 30 choice \
        --title "Dialog Test" \
        --prompt "This is a test dialog from cursor-studio.\n\nFeatures:\n✓ Multiple choice\n✓ Timer with pause\n✓ Comment field\n\nIs everything working?" \
        --options '[{"value":"yes","label":"✓ Works great!"},{"value":"partial","label":"⚠ Partially working"},{"value":"no","label":"✗ Something is broken"}]'
}

# Launch Cursor with proxy support
launch_cursor_with_proxy() {
    local ca_cert="${PROXY_DIR}/ca-cert.pem"
    
    # Check if proxy CA exists
    if [[ ! -f "$ca_cert" ]]; then
        log_warn "Proxy CA not found. Initializing..."
        init_proxy
    fi
    
    # Create combined CA bundle
    local combined_bundle="${PROXY_DIR}/combined-ca-bundle.pem"
    
    log_info "Creating combined CA bundle..."
    cat /etc/ssl/certs/ca-certificates.crt "$ca_cert" > "$combined_bundle" 2>/dev/null || \
    cat /etc/ssl/certs/ca-bundle.crt "$ca_cert" > "$combined_bundle" 2>/dev/null || \
    cp "$ca_cert" "$combined_bundle"
    
    # Check if proxy is running
    if ! pgrep -f "cursor-proxy.*start" > /dev/null; then
        log_info "Starting proxy in background..."
        # Start proxy with transparent mode (needs sudo for iptables)
        if [[ $(id -u) -eq 0 ]] || sudo -n true 2>/dev/null; then
            nohup "$PROXY_BIN" start --transparent > "${PROXY_DIR}/proxy.log" 2>&1 &
            sleep 2
        else
            log_warn "Cannot start transparent proxy without sudo"
            log_info "Starting explicit proxy mode..."
            nohup "$PROXY_BIN" start > "${PROXY_DIR}/proxy.log" 2>&1 &
            sleep 2
        fi
    else
        log_info "Proxy already running"
    fi
    
    log_success "Launching Cursor with proxy support..."
    
    # Launch Cursor with CA trust
    export NODE_EXTRA_CA_CERTS="$combined_bundle"
    export NODE_TLS_REJECT_UNAUTHORIZED="0"  # Fallback if combined bundle fails
    
    # Find cursor binary
    local cursor_cmd
    if command -v cursor &>/dev/null; then
        cursor_cmd="cursor"
    elif [[ -f "/usr/bin/cursor" ]]; then
        cursor_cmd="/usr/bin/cursor"
    elif [[ -f "${HOME}/.local/bin/cursor" ]]; then
        cursor_cmd="${HOME}/.local/bin/cursor"
    else
        # Try to find via nix
        cursor_cmd=$(command -v cursor 2>/dev/null || echo "cursor")
    fi
    
    exec "$cursor_cmd" "$@"
}

# Launch Cursor normally
launch_cursor() {
    # Find cursor binary
    local cursor_cmd
    if command -v cursor &>/dev/null; then
        cursor_cmd="cursor"
    elif [[ -f "/usr/bin/cursor" ]]; then
        cursor_cmd="/usr/bin/cursor"
    elif [[ -f "${HOME}/.local/bin/cursor" ]]; then
        cursor_cmd="${HOME}/.local/bin/cursor"
    else
        cursor_cmd=$(command -v cursor 2>/dev/null || echo "cursor")
    fi
    
    exec "$cursor_cmd" "$@"
}

# Show help
show_help() {
    cat << EOF
cursor-studio - Enhanced Cursor IDE launcher with proxy and dialog support

USAGE:
    cursor-studio [OPTIONS] [-- CURSOR_ARGS...]
    cursor-studio proxy <COMMAND>
    cursor-studio dialog <COMMAND>

OPTIONS:
    --proxy, -p       Launch Cursor with proxy enabled
    --dialog, -d      Start dialog daemon before launch
    --help, -h        Show this help message

PROXY COMMANDS:
    cursor-studio proxy init          Initialize proxy (generate CA)
    cursor-studio proxy start         Start proxy server
    cursor-studio proxy stop          Stop proxy server
    cursor-studio proxy enable        Enable proxy in configuration
    cursor-studio proxy disable       Disable proxy (stops if running)
    cursor-studio proxy status        Show proxy status
    cursor-studio proxy trust-ca      Show/export CA certificate
    cursor-studio proxy cleanup       Clean up proxy resources
    cursor-studio proxy iptables      Manage iptables rules

DIALOG COMMANDS:
    cursor-studio dialog enable       Enable dialog feature (start daemon + install rules)
    cursor-studio dialog disable      Disable dialog feature (stop daemon + remove rules)
    cursor-studio dialog start        Start dialog daemon
    cursor-studio dialog stop         Stop dialog daemon
    cursor-studio dialog status       Show dialog daemon status
    cursor-studio dialog test         Show a test dialog

EXAMPLES:
    # Normal Cursor launch
    cursor-studio

    # Launch with proxy
    cursor-studio --proxy

    # Enable interactive dialogs (one-time setup)
    cursor-studio dialog enable

    # Launch with dialog support
    cursor-studio --dialog

    # Check dialog status
    cursor-studio dialog status

    # Test dialog system
    cursor-studio dialog test

For more information, see:
  - Proxy: ${SCRIPT_DIR}/cursor-proxy/ARCHITECTURE.md
  - Dialogs: ${SCRIPT_DIR}/cursor-dialog-daemon/README.md
EOF
}

# Launch Cursor with dialog daemon
launch_cursor_with_dialog() {
    # Check if feature is enabled, if not just ensure daemon runs
    if [[ -f "$DIALOG_CONFIG" ]] && grep -q "DIALOG_ENABLED=true" "$DIALOG_CONFIG" 2>/dev/null; then
        log_info "Dialog feature enabled"
    else
        log_warn "Dialog feature not enabled. Enable with: cursor-studio dialog enable"
    fi
    
    # Start daemon if not running
    if ! is_dialog_daemon_running; then
        start_dialog_daemon || log_warn "Could not start dialog daemon"
    fi
    
    # Launch Cursor
    launch_cursor "$@"
}

# Main entry point
main() {
    # Ensure directories exist
    mkdir -p "$PROXY_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$CURSOR_RULES_DIR"
    
    case "${1:-}" in
        --proxy|-p)
            shift
            launch_cursor_with_proxy "$@"
            ;;
        --dialog|-d)
            shift
            launch_cursor_with_dialog "$@"
            ;;
        proxy)
            shift
            case "${1:-}" in
                init)       shift; init_proxy "$@" ;;
                start)      shift; start_proxy "$@" ;;
                stop)       shift; stop_proxy "$@" ;;
                enable)     shift; enable_proxy "$@" ;;
                disable)    shift; disable_proxy "$@" ;;
                status)     shift; proxy_status "$@" ;;
                trust-ca)   shift; trust_ca "$@" ;;
                cleanup)    shift; cleanup_proxy "$@" ;;
                iptables)   shift; manage_iptables "$@" ;;
                *)          show_help; exit 1 ;;
            esac
            ;;
        dialog)
            shift
            case "${1:-}" in
                enable)     shift; enable_dialog_feature "$@" ;;
                disable)    shift; disable_dialog_feature "$@" ;;
                start)      shift; start_dialog_daemon "$@" ;;
                stop)       shift; stop_dialog_daemon "$@" ;;
                status)     shift; dialog_status "$@" ;;
                test)       shift; dialog_test "$@" ;;
                *)          show_help; exit 1 ;;
            esac
            ;;
        --help|-h)
            show_help
            ;;
        *)
            # Auto-start dialog daemon if enabled
            if [[ -f "$DIALOG_CONFIG" ]] && grep -q "DIALOG_ENABLED=true" "$DIALOG_CONFIG" 2>/dev/null; then
                if ! is_dialog_daemon_running; then
                    start_dialog_daemon || true
                fi
            fi
            launch_cursor "$@"
            ;;
    esac
}

main "$@"

